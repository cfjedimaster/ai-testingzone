{% extends 'layout.html' %}

{% block content %}
<section>
    <h2>Search Form</h2>
    <form>
        <label for="storeSelect">Select Store:</label>
        <select id="storeSelect" name="storeSelect" required>
            <option value="">Choose a store...</option>
            {% for store in stores %}
            <option value="{{ store.name }}">{{ store.display_name }}</option>
            {% endfor %}
        </select>
        <label for="query">Search Query:</label>
        <input type="search" id="query" name="query" required>
        <label for="metadata">Metadata (optional):</label>
        <input type="text" id="metadata" name="metadata" placeholder='filename = "something.pdf"'>
        <button type="submit">Search this Store</button>
    </form>

    <h2>Result</h2>
    <div id="result"></div>


<script>
let $store, $query, $metadata, $result;

document.addEventListener('DOMContentLoaded', init, false);
async function init() {
    $store = document.querySelector('#storeSelect');
    $query = document.querySelector('#query');
    $metadata = document.querySelector('#metadata');
    $result = document.querySelector('#result');
    document.querySelector('form').addEventListener('submit', search);
}

async function search(e) {
    e.preventDefault();
    $result.innerHTML = '';

    let storeName = $store.value;
    let query = $query.value;
    let metadata = $metadata.value;

    if(!storeName.trim() || !query.trim()) {
        alert('Please select a store and enter a search query.');
        return;
    }

    let payload = {
        store: storeName,
        query, 
        metadata
    };

    console.log('Searching with payload:', payload);
    $result.innerHTML = '<i>Searching...</i>';

    let results = await fetch('/storesearch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    });
    let data = await results.json();
    console.log('Search results:', data);

    $result.innerHTML = marked.parse(data.result);
}
</script>

</section>


{% endblock %}